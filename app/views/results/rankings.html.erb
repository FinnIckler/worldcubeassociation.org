<% provide(:title, t(".title")) %>

<% ranking_timestamp = ComputeAuxiliaryData.successful_start_date || Date.current %>
<% @rows = DbHelper.execute_cached_query(@cache_params, ranking_timestamp, @query) %>

<div class="container">
  <h1><%= yield(:title) %></h1>
  <p><%= t("results.last_updated_html", timestamp: wca_local_time(ranking_timestamp)) %></p>
  <p><i><%= t('results.filters_fixes_underway') %></i></p>

  <div id="results-selector" class="results-select form-inline">
    <%= render 'results_selector', show_rankings_options: true %>
  </div>
  <% cache [*@cache_params, ranking_timestamp, I18n.locale] do %>
    <%
      comp_ids = @rows.map { |r| r["competitionId"] }.uniq
      @competitions_by_id = Hash[Competition.where(id: comp_ids).map { |c| [c.id, c] }]
    %>
    <%= react_component("Results/Rankings", {
      rows: @rows.as_json, competitionsById: @competitions_by_id.as_json({ methods: %w[country name id], includes: [] }), isAverage: @is_average, isByRegion: @is_by_region,
    }) %>
  <% end %>
</div>
